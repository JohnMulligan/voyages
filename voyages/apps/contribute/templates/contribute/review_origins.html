{% extends "_base.html" %}
{% load sass_tags %}
{% load compress %}
{% load i18n %}

{% block title %}
	{% trans 'Contribution to the Origins Database' %}
{% endblock %}

{% block content %}
<style>
    .overwrite {
        text-decoration: line-through;
    }
</style>
<div class="trans-container">
    <div id="center-content-inner" class="enslaved-content">
        <center>
            <h2>{% trans "Origins Contribution Review" %}</h2>
        </center>
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <div class="card" style="width: 18rem;">
                        <div class="card-body">
                            <h3 class="card-title">[[ contrib_data.enslaved.modern_name ]]</h5>
                            <h4 v-if="contrib_data.enslaved.historical_name" class="card-subtitle mb-2 text-muted">[[ contrib_data.enslaved.historical_name ]] {% trans "(historical)" %}</h6>
                            <p class="card-text">
                                [[ genders[contrib_data.enslaved.gender || 0] ]]
                                {% trans "embarked on " %}
                                [[ contrib_data.enslaved.region_of_embarkation ]]
                            </p>
                            <hr />
                            <h4>Contributed Names</h4>
                            <ul>
                                <li v-for="cn in contrib_data.contributed_names">
                                    [[ cn.name ]]
                                    <div v-if="cn.notes" style="display: inline; margin-left: 10px;">
                                        <i class="fa fa-comment" aria-hidden="true" v-bind:title="[[ cn.notes ]]"></i>
                                    </div>
                                    <div v-if="cn.audio" style="display: inline; margin-left: 10px;">
                                        <i class="fa fa-play" aria-hidden="true" v-bind:data="cn.audio" onclick="audioCommand(this.getAttribute('data'), 'play')"></i>
                                        <i class="fa fa-pause" aria-hidden="true" v-bind:data="cn.pk" onclick="audioCommand(null, 'pause')"></i>
                                    </div>
                                </li>
                            </ul>
                            <div v-if="contrib_data.prev_name_contributions.length > 0">
                                <em>
                                    {% trans "Previous contributions" %}: [[ contrib_data.prev_name_contributions.join(';') ]]
                                </em>
                            </div>
                            <h4>Contributed Language Groups</h4>
                            <span v-if="contrib_data.is_multilingual">{% trans "Multilingual" %}</span>
                            <ul>
                                <li v-for="cl in contrib_data.contributed_language_groups">
                                    [[ cl.language_group_name ]] ([[ cl.modern_country_name ]])
                                </li>
                            </ul>
                            <div v-if="contrib_data.prev_language_group_contributions.length > 0">
                                <em>
                                    {% trans "Previous contributions" %}: [[ contrib_data.prev_language_group_contributions.join(';') ]]
                                </em>
                            </div>
                            <div v-if="contrib_data.notes">
                                <hr />
                                <span>
                                    {% trans "Notes:" %} [[ contrib_data.notes ]]
                                </span>
                            </div>
                        </div>
                    </div>
                    <p>TO-DO</p>
                    <ul>
                        <li>✓ List modern name contributions</li>
                        <li>✓ Audio playback</li>
                        <li>✓ Language group</li>
                        <li>✓ Previous contributed names</li>
                        <li>✓ Propagation table: toggle row propagation</li>
                        <li>✓ Show contributor comments</li>
                        <li>Propagation table: editable notes</li>
                        <li>Submission: on accept popup with summary, on reject confirm</li>
                    </ul>
                </div>
                <div class="col-md-8">
                    <h3>Propagation</h3>                    
                    <label for="propagatedName">{% trans "Propagated Name" %}:</label>
                    <input class="form-control" name="propagatedName" type="text" v-model="propagatedName" />
                    <label for="propagatedCountry">{% trans "Propagated Modern Country" %}:</label>
                    <select id="propagatedCountry" class="form-control" v-model="propagatedCountry">
                        <option value="remove">{% trans "Delink Modern Country" %}</option>
                        <option v-if="contrib_data.contributed_language_groups" disabled>--- {% trans "User Contributed" %} ---</option>
                        <option v-if="contribCountries" v-for="pair in contribCountries" v-bind:value="pair[0]">[[ pair[1] ]]</option>
                        <option disabled>--- {% trans "Editorial Choices" %} ---</option>
                        <option v-for="country in modernCountryChoices" v-bind:value="country.pk">[[ country.name ]]</option>
                    </select>
                    <label for="propagatedLang">{% trans "Propagated Language Group" %}:</label>
                    <select id="propagatedLang" class="form-control" v-model="propagatedLanguage">
                        <option value="remove">{% trans "Delink Language Group" %}</option>
                        <option v-if="contrib_data.contributed_language_groups" disabled>--- {% trans "User Contributed" %} ---</option>
                        <option v-for="cl in contrib_data.contributed_language_groups" v-bind:value="cl.language_group_pk">[[ cl.language_group_name ]]</option>
                        <option v-if="languageGroupChoices.length > 0" disabled>--- {% trans "Editorial Choices" %} ---</option>
                        <option v-for="lang in languageGroupChoices" v-bind:value="lang.pk">[[ lang.name ]]</option>
                    </select>
                    <table id="propagationTable" class="table table-striped table-bordered dataTable">
                        <thead>
                            <tr>
                                <th>{% trans "Name(s)" %}</th>
                                <th>{% trans "Gender" %}</th>
                                <th>{% trans "Embarkation" %}</th>
                                <th>{% trans "Propagate Name" %}</th>
                                <th>{% trans "Propagate Language Group" %}</th>
                                <th>{% trans "Notes" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="btn-group" role="group" aria-label="Contribution actions">
                        <button v-on:click="accept" class="btn btn-primary">
                            {% trans "Accept" %}
                        </button>
                        <button v-on:click="reject" class="btn btn-danger">
                            {% trans "Reject" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editNotesModal" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">{% trans "Edit Notes for Enslaved" %}</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" style="height: 300px;">
                <textarea class="form-control" id="addedNotesInput" style="height: 100%;"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="updateEnslavedNotes()" type="button" class="btn btn-primary">{% trans "Update" %}</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
            </div>
        </div>
    </div>
</div>

<script src="{{ STATIC_URL }}scripts/library/vue@2.6.7.min.js" type="text/javascript"></script>
<script>
    const genders = [null, '{% trans "male" %}', '{% trans "female" %}'];
    let currentPlay = { file: '' };
    const audioCommand = (audio_file, cmd) => {
        if (cmd === 'play') {
            if (currentPlay.file !== audio_file) {
                if (!!currentPlay.audio) {
                    currentPlay.audio.pause();
                }
                currentPlay.file = audio_file;
                const audio = new Audio(audio_file);
                audio.addEventListener("canplaythrough", (event) => {
                    audio.play();
                    currentPlay.audio = audio;
                });
            } else if (currentPlay.audio?.readyState >= 3) {
                currentPlay.audio.play();
            }
        } else if (cmd === 'pause' && currentPlay.audio) {
            currentPlay.audio.pause();
        }
    };
    let activeNotesEdit = null;
    const showNotesModal = (src) => {
        const pk = $(src).data('pk');
        activeNotesEdit = pk;
        $("#addedNotesInput").val($("#notes_" + pk).text());
        $("#editNotesModal").modal('show');
    };
    const updateEnslavedNotes = () => {
        $("#notes_" + activeNotesEdit).text($("#addedNotesInput").val());
        $("#editNotesModal").modal('hide');
    };
    const fetchGet = async (url) => {
        const res = await fetch(url);
        return await res.json();
    };
    async function initialize() {
        const contrib_data = await fetchGet("/contribute/origins_contribution_details/{{ contribution.pk }}")
        const { modernCountryChoices, languageGroupChoices, m2m } = await fetchGet('/contribute/language_choices');
        modernCountryChoices.sort((a, b) => a.name.localeCompare(b.name));
        const allLanguages = {};
        for (const l of languageGroupChoices) {
            allLanguages[l.pk] = l;
        }
        let countries = {};
        contrib_data.contributed_language_groups
            .forEach(cl => {
                if (cl.modern_country_pk) {
                    countries[cl.modern_country_pk] = cl.modern_country_name;
                }
            });
        countries = Object.entries(countries)
        let propagatedCountry = Object.keys(countries).length === 1 ? parseInt(countries[0][0]) : null;
        let propagatedLanguage = contrib_data.contributed_language_groups.length === 1
            ? parseInt(contrib_data.contributed_language_groups[0].language_group_pk)
            : null;
        $("#propagationTable").DataTable({
            data: contrib_data.propagation_candidates,
            columns: [{
                    data: row => {
                        let name = row.documented_name;
                        const moreNames = [row.name_first, row.name_second, row.name_third].filter(x => !!x).join('');
                        if (moreNames) {
                            name = `${name} (${moreNames})`;
                        }
                        return name;
                    }
                },
                { data: row => genders[row.gender] },
                { data: 'embarkation' },
                {
                    data: row => ({ pk: row.pk, modernName: row.modern_name }),
                    render: function(data, type) {
                        if (type === 'display') {
                            return `<input type="checkbox" checked="true" value="N${data.pk}"> <span id="cell_N${data.pk}" class="font-weight-light overwrite">${data.modernName}</span>`;
                        }
                        return data;
                    }
                }, {
                    data: row => ({ pk: row.pk, language: row.language_group__name }),
                    render: function(data, type) {
                        if (type === 'display') {
                            return `<input type="checkbox" checked="true" value="L${data.pk}"> <span id="cell_L${data.pk}" class="font-weight-light overwrite">${data.language}</span>`;
                        }
                        return data;
                    }
                }, {
                    data: row => ({ pk: row.pk, notes: row.notes }),
                    render: function(data, type) {
                        if (type === 'display') {
                            return `<button type="button" onclick="showNotesModal(this)" data-pk="${data.pk}" class="btn btn-primary btn-sm"><i class="fa fa-sticky-note-o" aria-hidden="true"></i>
                                </button>
                                <span id="notes_${data.pk}">${data.notes}</span>`;
                        }
                        return data;
                    }
                }
            ],
            scrollY: '30vh',
            paginate: contrib_data.propagation_candidates.length > 10,
            info: false,
            bFilter: false,
            pageLength: 10,
            bLengthChange: false
        });
        const viewModel = new Vue({
            el: "#center-content-inner",
            delimiters: ['[[', ']]'],
            data: {
                contrib_data,
                propagatedName: contrib_data.contributed_names.length === 1 ? contrib_data.contributed_names[0].name : '',
                modernCountryChoices,
                contribCountries: countries,
                propagatedCountry,
                propagatedLanguage
            },
            computed: {
                languageGroupChoices: function() {
                    if (!this.propagatedCountry) {
                        return [];
                    }
                    return m2m
                        .filter(x => x.moderncountry_id === this.propagatedCountry)
                        .map(x => allLanguages[x.languagegroup_id]);
                }
            },
            methods: {
                accept: async function() {
                    alert('not implemented');
                },
                reject: async function() {
                    alert('not implemented');
                }
            }
        });
        $(":checkbox").change(function() {
            const target = $("#cell_" + $(this).attr('value'));
            if (this.checked) {
                target.addClass("overwrite");
            } else {
                target.removeClass("overwrite");
            }
        });
    }
    try {
        initialize();
    } catch {
        alert("An error has occurred");
    }
</script>

{% endblock %}